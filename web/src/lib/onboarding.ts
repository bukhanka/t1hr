import { prisma } from '@/lib/prisma'

// –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞  
export async function buildOnboardingSystemPrompt(userId: string): Promise<string> {
  const profile = await prisma.profile.findUnique({
    where: { userId },
    include: {
      user: {
        select: {
          name: true,
          email: true
        }
      },
      userSkills: {
        include: { skill: true }
      },
      userProjects: {
        include: { project: true }
      },
      careerGoals: true
    }
  })

  if (!profile) {
    return getBasicOnboardingPrompt()
  }

  // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á—Ç–æ —É–∂–µ –∑–Ω–∞–µ–º
  const knownData = analyzeKnownData(profile)
  const missingData = analyzeMissingData(profile)

  return `–¢—ã - –ù–∞–≤–∏–≥–∞—Ç–æ—Ä, –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è –£–ú–ù–û–ì–û –û–ù–ë–û–†–î–ò–ù–ì–ê —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ T1.

üéØ –ì–õ–ê–í–ù–´–ô –ü–†–ò–ù–¶–ò–ü: "–ü–æ–∫–∞–∂–∏ —á—Ç–æ –∑–Ω–∞–µ—à—å, —Å–ø—Ä–æ—Å–∏ —á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—à—å"

üìã –ß–¢–û –£–ñ–ï –ò–ó–í–ï–°–¢–ù–û –û –°–û–¢–†–£–î–ù–ò–ö–ï:
${knownData.length > 0 ? knownData.map(item => `‚úÖ ${item}`).join('\n') : '‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'}

üîç –ß–¢–û –ù–£–ñ–ù–û –£–ó–ù–ê–¢–¨ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã):
${missingData.map((item, index) => `${index + 1}. ${item}`).join('\n')}

üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°:
- –ò–º—è: ${profile.user.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
- –î–æ–ª–∂–Ω–æ—Å—Ç—å: ${profile.jobTitle || '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}
- –û—Ç–¥–µ–ª: ${profile.department || '‚ùì –ù–µ —É–∫–∞–∑–∞–Ω'}
- –ù–∞–≤—ã–∫–∏: ${profile.userSkills.length} (—Ü–µ–ª—å: 5-8)
- –ü—Ä–æ–µ–∫—Ç—ã: ${profile.userProjects.length} (—Ü–µ–ª—å: 1-2 —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏)
- –ö–∞—Ä—å–µ—Ä–Ω—ã–µ —Ü–µ–ª–∏: ${profile.careerGoals.length} (—Ü–µ–ª—å: 1-2)
- –£—Ä–æ–≤–µ–Ω—å: ${profile.level} (${profile.xp} XP)
- T-Coins: ${profile.tCoins}

üöÄ –°–¢–†–ê–¢–ï–ì–ò–Ø –ò–ù–¢–ï–†–í–¨–Æ:
1. **–ü–†–ò–ó–ù–ê–ù–ò–ï** - –ø–æ–∫–∞–∂–∏ —á—Ç–æ —Ç—ã —É–∂–µ –∑–Ω–∞–µ—à—å –ø—Ä–æ –Ω–µ–≥–æ (—Å–æ–∑–¥–∞–π wow-—ç—Ñ—Ñ–µ–∫—Ç)
2. **–î–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï** - —É–º–Ω–æ —Å–ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ –ù–ï–î–û–°–¢–ê–Æ–©–ï–ï
3. **–ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø** - –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥ –µ–≥–æ —Ä–æ–ª—å/–æ—Ç–¥–µ–ª
4. **–ú–û–¢–ò–í–ê–¶–ò–Ø** - –æ–±—ä—è—Å–Ω—è–π —Ü–µ–Ω–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

‚úÖ –ü–†–ê–í–ò–õ–ê:
- –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π —Ç–æ, —á—Ç–æ —É–∂–µ –∑–Ω–∞–µ—à—å
- –ù–ï –¥—É–±–ª–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ó–∞–¥–∞–≤–∞–π 1 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑
- –•–≤–∞–ª–∏ –∑–∞ –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç + —É–ø–æ–º–∏–Ω–∞–π T-Coins
- –í —Ñ–∏–Ω–∞–ª–µ –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è

–í–µ–¥–∏ –∏–Ω—Ç–µ—Ä–≤—å—é —É–º–Ω–æ, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏ —Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º!`
}

// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á—Ç–æ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
function analyzeKnownData(profile: any): string[] {
  const known: string[] = []

  if (profile.jobTitle) {
    known.push(`–î–æ–ª–∂–Ω–æ—Å—Ç—å: ${profile.jobTitle}`)
  }
  
  if (profile.department) {
    known.push(`–û—Ç–¥–µ–ª: ${profile.department}`)
  }

  if (profile.userSkills.length > 0) {
    const skillNames = profile.userSkills.map((us: any) => us.skill.name).slice(0, 3)
    known.push(`–ù–∞–≤—ã–∫–∏: ${skillNames.join(', ')}${profile.userSkills.length > 3 ? ` –∏ –µ—â–µ ${profile.userSkills.length - 3}` : ''}`)
  }

  if (profile.userProjects.length > 0) {
    known.push(`–£—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ ${profile.userProjects.length} –ø—Ä–æ–µ–∫—Ç–µ(–∞—Ö)`)
  }

  if (profile.careerGoals.length > 0) {
    known.push(`–ö–∞—Ä—å–µ—Ä–Ω—ã–µ —Ü–µ–ª–∏: ${profile.careerGoals.map((cg: any) => cg.target).join(', ')}`)
  }

  if (profile.xp > 100) {
    known.push(`–û–ø—ã—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (${profile.xp} XP)`)
  }

  return known
}

// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á—Ç–æ –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å
function analyzeMissingData(profile: any): string[] {
  const missing: string[] = []

  if (!profile.jobTitle) {
    missing.push("–¢–µ–∫—É—â–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å –∏ —Ä–æ–ª—å –≤ –∫–æ–º–∞–Ω–¥–µ")
  }

  if (!profile.department) {
    missing.push("–û—Ç–¥–µ–ª –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã")
  }

  if (profile.userSkills.length < 3) {
    missing.push("–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –Ω–∞–≤—ã–∫–∏ (—Ü–µ–ª—å: 5-8 –Ω–∞–≤—ã–∫–æ–≤)")
  } else if (profile.userSkills.length < 5) {
    missing.push("–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è")
  }

  if (profile.userProjects.length === 0) {
    missing.push("–°–∞–º—ã–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π/–∫—Ä—É–ø–Ω—ã–π –ø—Ä–æ–µ–∫—Ç + —Ä–æ–ª—å + –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è")
  } else {
    const projectsWithoutAchievements = profile.userProjects.filter((up: any) => !up.achievements).length
    if (projectsWithoutAchievements > 0) {
      missing.push("–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö (—á—Ç–æ —Å–¥–µ–ª–∞–ª, –∫–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)")
    }
  }

  if (profile.careerGoals.length === 0) {
    missing.push("–ö–∞—Ä—å–µ—Ä–Ω—ã–µ –ø–ª–∞–Ω—ã: –∫—É–¥–∞ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è, —á—Ç–æ –∏–∑—É—á–∞—Ç—å")
  }

  // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ —Å—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ —É–∂–µ –µ—Å—Ç—å
  if (profile.userSkills.length >= 3 && profile.userProjects.length >= 1) {
    missing.push("–ß—Ç–æ –±–æ–ª—å—à–µ –Ω—Ä–∞–≤–∏—Ç—Å—è: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –∏–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π")
    missing.push("–ö–∞–∫–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è T1 –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è")
  }

  return missing.slice(0, 4) // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 4 –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤
}

// –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
function getBasicOnboardingPrompt(): string {
  return `–¢—ã - –ù–∞–≤–∏–≥–∞—Ç–æ—Ä, –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ T1.

–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Å –Ω—É–ª—è –∑–∞ 5-7 –º–∏–Ω—É—Ç.

–≠–¢–ê–ü–´:
1. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∏ —É–∑–Ω–∞–π –∏–º—è
2. –î–æ–ª–∂–Ω–æ—Å—Ç—å –∏ —Ä–æ–ª—å  
3. –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ (3-5)
4. –õ—É—á—à–∏–π –ø—Ä–æ–µ–∫—Ç + –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
5. –ö–∞—Ä—å–µ—Ä–Ω—ã–µ —Ü–µ–ª–∏
6. –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è

–ü–†–ê–í–ò–õ–ê:
- –ó–∞–¥–∞–≤–∞–π –ø–æ 1 –≤–æ–ø—Ä–æ—Å—É –∑–∞ —Ä–∞–∑
- –•–≤–∞–ª–∏ –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç
- –£–ø–æ–º–∏–Ω–∞–π T-Coins –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –í–µ–¥–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω–æ

–ù–∞—á–∏–Ω–∞–π —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞!`
}
